# -*- coding : utf-8 -*-
"""
Created on Tue Mar 12 15:37:47 2019

@author: python
"""
from toolz import keyfilter, valmap
from strategy.indicator.technic import Power
from strategy import Strategy


class Momentum(Strategy):
    """
        åŠ¨é‡ç­–ç•¥ --- åŸºäºä»·æ ¼ã€æˆäº¤é‡ -- DPower åº¦é‡åŠ¨é‡
        å‚æ•° ï¼š æœ€é«˜ä»·æ ¼ã€æœ€ä½ä»·ã€æ”¶ç›˜ä»·ã€æˆäº¤é‡ï¼Œæ—¶é—´çª—å£
        é€»è¾‘ï¼š
            1ã€è®¡ç®—å›ºå®šåŒºé—´å†…çš„æ‰€æœ‰è‚¡ç¥¨çš„ç´¯è®¡åŠ¨é‡
            2ã€åŠ¨èƒ½æœ€é«˜ç‚¹ä¸ä»·æ ¼æœ€é«˜ç‚¹çš„æ—¶é—´åå·®ï¼Œä¸€èˆ¬æ¥è®²åŠ¨èƒ½é«˜ç‚¹å…ˆå‡ºç°
            3ã€è®¡ç®—2ä¸­æ—¶é—´åå·®çš„æ”¶ç›Š
        æ³¨æ„ç‚¹ï¼šå±äºè¶‹åŠ¿èŒƒç•´ -- æƒ¯æ€§ç‰¹è´¨ ï¼Œä¸é€‚ç”¨äºåå¼¹

        é€»è¾‘ï¼š
        1ã€åŸºäºå®æˆ˜çš„æ£€éªŒï¼Œé‡è¦ä¸Šå¸‚å…¬å‘Šçš„å½±å“äº§ç”Ÿå…·æœ‰ä¸€ä¸ªé•¿æœŸçš„æ•ˆåº”ï¼ŒçŸ­æœŸçš„æ”¶åˆ°æŠ•èµ„è€…çƒ­æ§ï¼Œç”±äºçŸ­è§†æ•ˆåº”ä»¥åŠè·åˆ©å›åçš„å½±å“ï¼Œä½†æ˜¯ç”±äºçƒ­ç‚¹æ€§è´¨ä»¥åŠğŸ§ç¬¬ä¸‰æ–¹æœºæ„çš„
           ç›ˆåˆ©éœ€æ±‚çš„å­˜åœ¨ï¼Œè‚¡ä»·ç»§ç»­ä¸Šè¡Œï¼Œä½†æ˜¯å‰æœŸè·åˆ©ä»¥åŠè§‚æœ›çš„æŠ•èµ„è€…ç”±äºé”šå®šæ•ˆåº”ï¼Œä¸æ•¢ä¹°å…¥ï¼Œä½†æ˜¯éšç€ä»·æ ¼ä¸Šå‡ï¼Œå†…å¿ƒçš„ç›ˆåˆ©æœŸæœ›è¶…è¿‡ææƒ§ä¹°å…¥ï¼Œä½†æ˜¯æœºæ„è·åˆ©ç›˜é€€å‡ºï¼Œ
           å‘¨è€Œå¤å§‹è¿™ä¸ªè¿‡ç¨‹ï¼Œï¼ˆèºæ—‹å¼ä¸Šå‡ï¼Œæ³¢æµªç†è®ºï¼‰
        2ã€ç›‘æ§ä¸Šè¿°è‚¡ç¥¨å›è°ƒä¹‹åï¼Œä¸€æ—¦å‡ºç°çªç ´å‰æœŸé«˜ç‚¹ï¼Œä¹°å…¥
        3ã€ç›‘æ§äº‹ä»¶çš„é•¿æœŸå½±å“ï¼ˆå¿ƒç†ä¸ŠæŠ•èµ„åå·®ï¼‰

        --- å¤§å¸‚å€¼çš„æ ‡çš„å•æ—¥æ¶¨å¹…è¶…è¿‡ä¸€å®šç¨‹åº¦ï¼ŒåæœŸå­˜åœ¨æ¥åŠ›çš„å¯èƒ½è¡Œï¼ˆä¹°å…¥ï¼‰
        åˆ†æå…¨Aè‚¡ç¥¨è¿›è¡Œç»Ÿè®¡åˆ†æï¼Œç«ç§å–æ — --- åœ¨åŠ¨é‡åˆ°è¾¾é«˜ç‚¹ï¼Œä»‹å…¥ç­‰åˆ°åŠ¨é‡ä¸‹é™ä¸€å®šåˆ°æ¯”ä¾‹çš„é˜ˆå€¼ï¼Œå–å‡º --- ç”±äºæ—¶é—´å·®
        output --- mask
    """
    def __init__(self,
                 params,
                 universe_func):
        self.params = params
        self._universe_func = universe_func

    def _compute(self, feed, mask):
        frame = keyfilter(lambda x: x in mask, feed)
        out = dict()
        for sid, data in frame:
            power = Power.compute(frame, self.params)
            out[sid] = self._universe_func(power)
        # filter
        _mask = valmap(lambda x: x >= self.params['threshold'], out)
        return list(_mask.keys())




